<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Campus Map</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <style>
      html, body, #map { height: 100%; width: 100%; margin: 0; padding: 0; }
      .pin {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 2px solid #fff;
        box-shadow: 0 3px 5px rgba(0,0,0,0.25);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .pin svg { width: 16px; height: 16px; }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script>
      // ESPRIT University coordinates (Z.I. Charguia, Tunis, Tunisia)
      const esprit = [36.8983, 10.1896];

      const map = L.map('map', {
        center: esprit,
        zoom: 16,
        zoomControl: true,
        scrollWheelZoom: true,
      });

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 19,
      }).addTo(map);

      // Campus boundary circle (red, like the mock)
      L.circle(esprit, {
        color: '#D32F2F',
        fillColor: '#D32F2F',
        fillOpacity: 0.10,
        radius: 150,
      }).addTo(map);

      // ESPRIT marker (home)
      const espritIcon = L.divIcon({
        className: '',
        html: `
          <div class="pin" style="background:#D32F2F;">
            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
          </div>
        `,
        iconSize: [32, 32],
        iconAnchor: [16, 16],
      });
      L.marker(esprit, { icon: espritIcon }).addTo(map);

      // Markers managed from Android
      let buildingLayer = L.layerGroup().addTo(map);

      function colorForType(type) {
        switch ((type || '').toLowerCase()) {
          case 'faculty': return '#D32F2F';
          case 'library': return '#1E40AF';
          case 'lab': return '#D97706';
          case 'admin': return '#4F46E5';
          case 'cafeteria': return '#059669';
          case 'sports': return '#DB2777';
          default: return '#D32F2F';
        }
      }

      // Called by Android: setBuildings([{id,name,type,lat,lng},...])
      window.setBuildings = function(buildings) {
        buildingLayer.clearLayers();
        if (!Array.isArray(buildings)) return;

        buildings.forEach(b => {
          if (typeof b.lat !== 'number' || typeof b.lng !== 'number') return;

          const col = colorForType(b.type);
          const icon = L.divIcon({
            className: '',
            html: `
              <div class="pin" style="background:${col};">
                <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                  <rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect>
                  <path d="M9 22v-4h6v4"></path>
                </svg>
              </div>
            `,
            iconSize: [32, 32],
            iconAnchor: [16, 16],
          });

          const m = L.marker([b.lat, b.lng], { icon }).addTo(buildingLayer);
          m.on('click', () => {
            if (window.AndroidBridge && window.AndroidBridge.onBuildingSelected) {
              window.AndroidBridge.onBuildingSelected(String(b.id || ''));
            }
          });
        });
      }

      // Called by Android: focusBuilding(lat,lng,zoom)
      window.focusBuilding = function(lat, lng, zoom) {
        const z = (typeof zoom === 'number') ? zoom : 17;
        map.setView([lat, lng], z, { animate: true });
      }

      // Tap outside markers closes the Android popup
      map.on('click', () => {
        if (window.AndroidBridge && window.AndroidBridge.onMapTapped) {
          window.AndroidBridge.onMapTapped();
        }
      });
    </script>
  </body>
</html>
